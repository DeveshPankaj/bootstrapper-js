<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xterm</title>
  <link rel="stylesheet" href="https://unpkg.com/xterm/css/xterm.css">
  <style>
    * {
      margin: 0;
      padding: 0;
    }
    html, body {
      height: 100%;
      width: 100%;
      display: flex;
    }
    #terminal {
      flex: 1;
      height: 100vh;
      width: 100vw;
    }
    .xterm {
      width: 100%;
      height: 100%;
      font-family: 'Courier New', Courier, monospace; /* Monospace font to handle spacing */
      font-size: 14px;
      line-height: 1; /* Ensures no extra vertical spacing */
      background-color: black;
    }
  </style>
</head>
<body>
  <div id="terminal"></div>

  <script type="module">
    import 'https://unpkg.com/xterm/lib/xterm.js';
    const Terminal = window.Terminal;

    // Create a terminal instance with proper settings
    const terminal = new Terminal({
      cursorBlink: true,
      convertEol: true,
      fontSize: 14,
      fontFamily: 'Courier New', // Set monospace font to fix spacing issues
      theme: {
        background: '#000000', // Black background
        foreground: '#00FF00', // Green text
      }
    });

    // Attach the terminal to the DOM element
    terminal.open(document.getElementById('terminal'));

    // Ensure the terminal resizes to full screen
    terminal.resize(Math.floor(window.innerWidth / 9), Math.floor(window.innerHeight / 18));

    // Neofetch-style message with correct spacing
const neofetchMessage = `
\x1b[33m        .--.                  \x1b[0m\x1b[34mLinux Terminal\x1b[0m
\x1b[33m       |o_o |                 \x1b[34mOS: Linux x86_64\x1b[0m
\x1b[33m       |:_/ |                 \x1b[34mShell: xterm.js\x1b[0m
\x1b[33m      //   \\ \\                \x1b[34mUptime: 10m\x1b[0m
\x1b[33m     (|     | )               \x1b[34mPackages: 1024\x1b[0m
\x1b[33m    /'\\_   _/\`\\               \x1b[34mMemory: 512MB / 2048MB\x1b[0m
\x1b[33m    \\___)=(___/               \x1b[34mCPU: Intel i5\x1b[0m

root@pankajdevesh.com: ~/home$`;

const neofetchMessage1 = `
\x1b[34m         .-^-.\n        /_._._\\\n       |  o o  |\x1b[0m\x1b[36m Mac Terminal\x1b[0m
\x1b[34m       |   \\_/  |                \x1b[36mOS: macOS Monterey\x1b[0m
\x1b[34m        \\  ~~~  /                \x1b[36mShell: zsh\x1b[0m
\x1b[34m         '-...-'                 \x1b[36mUptime: 5h 30m\x1b[0m
\x1b[34m                                   \x1b[36mPackages: 67\x1b[0m
\x1b[34m                                   \x1b[36mMemory: 8GB / 16GB\x1b[0m
\x1b[34m                                   \x1b[36mCPU: M1 Pro\x1b[0m

user@macbook: ~\$`;

    
const neofetchMessage2 = `
\x1b[36m         .--.\n        |o_o |\n        |:_/ |\x1b[0m\x1b[32m Linux Terminal\x1b[0m
\x1b[36m       _/   \\_                \x1b[32mOS: Ubuntu 22.04\x1b[0m
\x1b[36m      (|     | )              \x1b[32mShell: bash\x1b[0m
\x1b[36m       \\_   _/                \x1b[32mUptime: 1h 45m\x1b[0m
\x1b[36m         | |                  \x1b[32mPackages: 1500\x1b[0m
\x1b[36m        /   \\                 \x1b[32mMemory: 4GB / 16GB\x1b[0m
\x1b[36m       |     |                \x1b[32mCPU: Intel i7\x1b[0m

user@ubuntu: ~\$`;

const neofetchMessage3 = `
\x1b[35m         /\\_/\\\n        ( o.o )\n         > ^ < \x1b[0m\x1b[33m Windows Terminal\x1b[0m
\x1b[35m        ~~~~~~~~               \x1b[33mOS: Windows 11\x1b[0m
\x1b[35m                               \x1b[33mShell: PowerShell\x1b[0m
\x1b[35m                               \x1b[33mUptime: 2d 12h\x1b[0m
\x1b[35m                               \x1b[33mPackages: 112\x1b[0m
\x1b[35m                               \x1b[33mMemory: 16GB / 32GB\x1b[0m
\x1b[35m                               \x1b[33mCPU: Ryzen 7\x1b[0m

Admin@windows: C:\\Users\\Admin\$`;

const neofetchMessage4 = `
\x1b[31m         /\\     /\\\n        {  \`---'  }\n        {  O   O  }\x1b[0m\x1b[35m Fedora Terminal\x1b[0m
\x1b[31m        ~~~~~~~~                \x1b[35mOS: Fedora 36\x1b[0m
\x1b[31m                               \x1b[35mShell: fish\x1b[0m
\x1b[31m                               \x1b[35mUptime: 3h 20m\x1b[0m
\x1b[31m                               \x1b[35mPackages: 980\x1b[0m
\x1b[31m                               \x1b[35mMemory: 2GB / 8GB\x1b[0m
\x1b[31m                               \x1b[35mCPU: AMD Ryzen 5\x1b[0m

fedora@localhost: ~\$`;

const neofetchMessage5 = `
\x1b[36m         .--.\n        |o_o |\n        |:_/ |\x1b[0m\x1b[32m  Linux Terminal ðŸ˜Ž\x1b[0m
\x1b[36m       _/   \\_                \x1b[32mOS: Ubuntu 22.04 ðŸ§\x1b[0m
\x1b[36m      (|     | )              \x1b[32mShell: bash ðŸš\x1b[0m
\x1b[36m       \\_   _/                \x1b[32mUptime: 1h 45m â³\x1b[0m
\x1b[36m         | |                  \x1b[32mPackages: 1500 ðŸ“¦\x1b[0m
\x1b[36m        /   \\                 \x1b[32mMemory: 4GB / 16GB ðŸ§ \x1b[0m
\x1b[36m       |     |                \x1b[32mCPU: Intel i7 ðŸ’»\x1b[0m

user@ubuntu: ~\$`;

const neofetchMessage6 = `
\x1b[33m        .--.                  \x1b[0m\x1b[34mPankaj Devesh\x1b[0m
\x1b[33m       |o_o |                 \x1b[34mRole: Senior Software Engineer\x1b[0m
\x1b[33m       |:_/ |                 \x1b[34mTech Stack: TypeScript, Python\x1b[0m
\x1b[33m      //   \\\\\\                \x1b[34mPortfolio: pankajdevesh.com\x1b[0m
\x1b[33m     (|     | )               \x1b[34mExperience: 5 years\x1b[0m
\x1b[33m    /'\\_   _/\`\\               \x1b[34mProjects: Fullstack Development\x1b[0m
\x1b[33m    \\___)=(___/               \x1b[34mTech Focus: Microservices, CLI\x1b[0m

Type \x1b[33mhelp\x1b[0m to get available commands.
\x1b[32mroot\x1b[0m\x1b[36m@pankajdevesh.com\x1b[0m: \x1b[33m~/home/user1$\x1b[0m `;

const neofetchMessage7 = `
\x1b[33m     \\   ^__^               \x1b[0m\x1b[34mPankaj Devesh's Cow\x1b[0m
\x1b[33m      \\  (oo)\\_______       \x1b[34mSays: Hello World!\x1b[0m
\x1b[33m         (__)\\       )\\/\\    \x1b[34mMooing about Code!\x1b[0m
\x1b[33m             ||----w |        \x1b[34mTech Stack: TypeScript, Python\x1b[0m
\x1b[33m             ||     ||        \x1b[34mRole: Senior Software Engineer\x1b[0m

root@pankajdevesh.com: ~/projects$`;

    const welcome_msgs = [
      neofetchMessage,
      neofetchMessage1,
      neofetchMessage2,
      neofetchMessage3,
      neofetchMessage4,
      neofetchMessage5,
      neofetchMessage6,
      neofetchMessage7
    ]
    // terminal.write(welcome_msgs[6]);

    // Handle window resize events
    window.addEventListener('resize', () => {
      terminal.resize(Math.floor(window.innerWidth / 9), Math.floor(window.innerHeight / 18));
    });

    const context = {
      pwd:'/home/user1',
      PATH: '/bin:/usr/bin'
    }
    
const fs = platform.host.getFS();
let files = fs.readdirSync(context.pwd);
processCommand('info')

// Command history and index
let commandHistory = [];
let historyIndex = -1;

// Buffer to hold user input
let inputBuffer = '';

// Function to update the command line display
function updateCommandLine() {
  // Clear current line
  terminal.write(`\r\x1b[32mroot\x1b[0m\x1b[36m@pankajdevesh.com\x1b[0m: \x1b[33m~${context.pwd}$\x1b[0m ${' '.repeat(inputBuffer.length)}\r`);
  // Rewrite prompt and current input buffer
  terminal.write(`\x1b[32mroot\x1b[0m\x1b[36m@pankajdevesh.com\x1b[0m: \x1b[33m~${context.pwd}$\x1b[0m ${inputBuffer}`);
}

// Function to clear the terminal screen
function clearTerminal() {
  terminal.write('\x1b[2J\x1b[H');  // ANSI escape codes to clear the screen and move cursor to the top
}

// Handle user input
terminal.onData(data => {
  if (data === '\r') {  // Enter key
    terminal.write('\r\n');
    if (inputBuffer.trim() !== '') {
      processCommand(inputBuffer.trim());
      // Save command to history and reset index
      commandHistory.push(inputBuffer.trim());
      historyIndex = commandHistory.length;
    }
    inputBuffer = '';
    terminal.write(`\n\x1b[32mroot\x1b[0m\x1b[36m@pankajdevesh.com\x1b[0m: \x1b[33m~${context.pwd}$\x1b[0m `);
  } else if (data === '\u007F') {  // Backspace key
    if (inputBuffer.length > 0) {
      inputBuffer = inputBuffer.slice(0, -1);
      terminal.write('\b \b');
    }
  } else if (data === '\u001b[A') {  // Up arrow key
    if (historyIndex > 0) {
      historyIndex--;
      inputBuffer = commandHistory[historyIndex];
      updateCommandLine();
    }
  } else if (data === '\u001b[B') {  // Down arrow key
    if (historyIndex < commandHistory.length - 1) {
      historyIndex++;
      inputBuffer = commandHistory[historyIndex];
      updateCommandLine();
    } else {
      historyIndex = commandHistory.length;
      inputBuffer = '';
      updateCommandLine();  // Clear the input buffer
    }
  } else if (data === '\u000C') {  // Ctrl + L key (form feed, ASCII 12)
    clearTerminal();
    terminal.write(`\x1b[32mroot\x1b[0m\x1b[36m@pankajdevesh.com\x1b[0m: \x1b[33m~${context.pwd}$\x1b[0m `);
  } else {
    inputBuffer += data;
    terminal.write(data);
  }
});

// Process the entered command
function processCommand(command) {
  const cmdArgs = command.split(' ');

  let commandFile = ''
  const binDirs = context.PATH.split(':')
  for(const dir of binDirs) {
    const _commandFile = `${dir}/${cmdArgs[0]}.run`
    
    if(!fs.existsSync(_commandFile)) continue;
    commandFile = _commandFile
    break
  }
  
  if(commandFile) {
    platform.register('terminal', terminal)
    platform.register('context', context)
    platform.host.exec(platform, commandFile, context.pwd, ...cmdArgs.slice(1));
    return;
  }

  switch (cmdArgs[0]) {
    // case 'ls':
    //   terminal.write(`${files.join(' ')}\r\n`);
    //   break;

    case 'cd':
      if (cmdArgs.length < 2) {
        terminal.write('cd: missing operand\r\n');
      } else {
        let newDir = cmdArgs[1];

        if (newDir === '..') {
          const parentDir = context.pwd.split('/').slice(0, -1).join('/');
          newDir = parentDir || '/';
        } else if (!newDir.startsWith('/')) {
          newDir = `${context.pwd}/${newDir}`;
        }

        try {
          if (fs.statSync(newDir).isDirectory()) {
            context.pwd = newDir;
            files = fs.readdirSync(context.pwd);
          } else {
            terminal.write(`cd: ${newDir}: Not a directory\r\n`);
          }
        } catch (err) {
          terminal.write(`cd: ${newDir}: No such file or directory\r\n`);
        }
      }
      break;

    case 'edit':
      if (cmdArgs.length < 2) {
        terminal.write('edit: missing operand\r\n');
      } else {
        let file_name = cmdArgs[1];
        console.log(file_name)

        try {
          if (fs.statSync(`${context.pwd}/${file_name}`).isDirectory()) {
            terminal.write(`edit: ${file_name}: Not a file\r\n`);
          } else {
            platform.host.execCommand(`service('001-core.layout', 'open-window') (command('ui.notepad'), '${context.pwd}/${file_name}')`)
          }
        } catch (err) {
          terminal.write(`edit: ${file_name}: No such file or directory\r\n`);
        }
      }
      break;

    case 'clear':
      clearTerminal();
      terminal.write(`\x1b[32mroot\x1b[0m\x1b[36m@pankajdevesh.com\x1b[0m: \x1b[33m~${context.pwd}$\x1b[0m `);
      break;

    case 'help':
      terminal.write(`Available commands:\r\n - ls: List files\r\n - edit: Edit file\r\n - cd <dir>: Change directory\r\n - clear: Clear the terminal\r\n - help: Show this help\r\n - contact: Show contact info\r\n - ./<file_name>: Open a file\r\n`);
      break;

    case 'contact':
      terminal.write('Contact: pankaj.devesh@oracle.com\r\n');
      break;

    default:
      if (command.startsWith('./')) {
        const fileName = command.slice(2);
        if (files.includes(fileName)) {
          platform.host.exec(platform, `${context.pwd}/${fileName}`);
        } else {
          terminal.write(`Error: ${fileName} not found\r\n`);
        }
      } else {
        terminal.write(`Command not found: ${command}\r\n`);
      }
      break;
  }
}


  </script>
</body>
</html>
